<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles for Inter font and background */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0e7ff; /* Lighter blue background */
            background-image: radial-gradient(circle at center, #e0e7ff, #c3dafe); /* Subtle gradient */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            color: #2d3748; /* Darker text color */
        }
        /* Main container styling */
        .container {
            background-color: #ffffff;
            padding: 35px;
            border-radius: 20px; /* More rounded corners */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15); /* Stronger shadow */
            max-width: 950px; /* Slightly wider */
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 30px; /* Increased gap */
            animation: fadeInScale 0.6s ease-out forwards; /* Entry animation */
        }

        /* Keyframe for container entry animation */
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Input group layout */
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        /* Input field styling */
        .input-group input {
            flex-grow: 1;
            padding: 14px 20px; /* More padding */
            border: 1px solid #a7b9e0; /* Softer border color */
            border-radius: 12px; /* More rounded */
            font-size: 1.05rem;
            min-width: 200px; /* Default min-width */
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.08); /* Deeper inset shadow */
            transition: all 0.3s ease;
        }
        .input-group input:focus {
            border-color: #6366f1; /* Indigo focus */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); /* Ring effect */
        }
        /* Button base styles */
        .btn {
            padding: 13px 28px; /* More padding */
            border-radius: 12px; /* More rounded */
            font-weight: 700; /* Bolder text */
            cursor: pointer;
            transition: all 0.25s ease; /* Smoother transitions */
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Stronger shadow */
            position: relative;
            overflow: hidden;
        }
        /* Primary button styling */
        .btn-primary {
            background-image: linear-gradient(to right, #6366f1, #4c51bf); /* Gradient background */
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background-image: linear-gradient(to right, #4c51bf, #3b3f9d); /* Darker gradient on hover */
            transform: translateY(-3px); /* Lift effect */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); /* Enhanced shadow */
        }
        /* Secondary button styling */
        .btn-secondary {
            background-color: #f0f4f8; /* Lighter background */
            color: #4a5568; /* Darker text */
            border: 1px solid #cbd5e1;
        }
        .btn-secondary:hover {
            background-color: #e2e8f0;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        /* Ripple effect for buttons */
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            opacity: 0;
            transform: scale(0) translate(-50%, -50%);
            transition: width 0.4s ease-out, height 0.4s ease-out, opacity 0.4s ease-out;
        }
        .btn:active::after {
            width: 200%;
            height: 200%;
            opacity: 1;
            transition: 0s;
        }

        /* Data card styling */
        .data-card {
            background-color: #f8fafc; /* Very light background for cards */
            padding: 25px;
            border-radius: 16px;
            margin-top: 18px; /* Slightly more margin */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); /* Refined shadow */
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease-out; /* Smooth transition for display */
            opacity: 0; /* Hidden by default for animation */
            transform: translateY(20px); /* Slide up effect */
        }
        .data-card.show {
            opacity: 1;
            transform: translateY(0);
        }
        /* Initially hide all feature cards */
        .feature-card {
            display: none;
        }
        .feature-card.show {
            display: block; /* Override display: none when 'show' is added */
        }

        .data-card h3 {
            font-size: 1.45rem; /* Larger heading */
            font-weight: 800; /* Extra bold */
            color: #2d3748;
            margin-bottom: 15px;
            border-bottom: 3px solid #6366f1; /* Thicker, indigo border */
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .data-card h3 i {
            color: #6366f1; /* Icon color */
        }
        .data-card p, .data-card ul {
            font-size: 1.05rem; /* Slightly larger text */
            color: #4a5568;
            line-height: 1.8; /* More comfortable line height */
        }
        .data-card ul {
            list-style: none;
            padding: 0;
            margin-top: 8px;
        }
        .data-card ul li {
            margin-bottom: 8px;
            padding-left: 30px; /* More space for bullet */
            position: relative;
        }
        .data-card ul li::before {
            content: '✓'; /* Checkmark bullet */
            color: #34d399; /* Green checkmark */
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1.5em; /* Adjust position */
            position: absolute;
            left: 0;
        }
        /* Styling for "no content" messages in lists */
        .data-card ul li.no-content {
            font-style: italic;
            color: #718096; /* Lighter gray */
            padding-left: 0; /* Remove padding for these */
        }
        .data-card ul li.no-content::before {
            content: ''; /* Remove bullet for these */
        }

        /* Meaning section styling */
        .meaning-section {
            background-color: #f0f4f8; /* Slightly different background to differentiate */
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
            margin-bottom: 25px;
            border: 1px solid #d1d8e0;
            transition: all 0.3s ease-out;
            opacity: 0;
            transform: translateY(15px);
        }
        .meaning-section.show {
            opacity: 1;
            transform: translateY(0);
        }
        .meaning-section h4 {
            font-size: 1.25rem; /* Larger heading */
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 12px;
            border-bottom: 2px dashed #9ca3af; /* Dashed border */
            padding-bottom: 8px;
        }
        .meaning-section h5 {
            font-size: 1.1rem; /* Slightly larger */
            font-weight: 600;
            color: #4a5568;
            margin-top: 20px;
            margin-bottom: 8px;
        }

        /* Message modal styling */
        .message-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease; /* Smoother transition */
        }
        .message-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 40px; /* More padding */
            border-radius: 20px; /* More rounded */
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4); /* Stronger shadow */
            text-align: center;
            max-width: 500px; /* Slightly wider */
            width: 90%;
            transform: translateY(-30px) scale(0.9); /* Initial state for animation */
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
            opacity: 0;
        }
        .message-modal.show .modal-content {
            transform: translateY(0) scale(1); /* Final state for animation */
            opacity: 1;
        }
        .modal-content h3 {
            font-size: 2rem; /* Larger title */
            font-weight: 800;
            margin-bottom: 25px;
            color: #2d3748;
        }
        .modal-content p {
            margin-bottom: 35px;
            color: #4a5568;
            font-size: 1.1rem; /* Slightly larger message */
        }
        .modal-content button {
            background-image: linear-gradient(to right, #6366f1, #4c51bf);
            color: white;
            padding: 14px 30px; /* More padding */
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.25s ease;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .modal-content button:hover {
            background-image: linear-gradient(to right, #4c51bf, #3b3f9d);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        /* Saved words list styling */
        .saved-words-list {
            list-style: none;
            padding: 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* Adjusted column width */
            gap: 15px; /* Increased gap */
            min-height: 50px; /* Ensure it takes up some space */
        }
        .saved-words-list li {
            background-color: #e0e7ff; /* Lighter blue for saved words */
            padding: 15px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.25s ease;
            font-weight: 600;
            color: #2d3748;
            text-align: center;
            word-break: break-word;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        .saved-words-list li:hover {
            background-color: #c7d2fe;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        .saved-words-list li::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: #6366f1; /* Accent top border */
            transform: translateX(-100%);
            transition: transform 0.3s ease-out;
        }
        .saved-words-list li:hover::before {
            transform: translateX(0);
        }

        /* Pronunciation row styling */
        .pronunciation-row {
            display: flex;
            align-items: center;
            gap: 20px; /* More space */
            margin-bottom: 12px;
            background-color: #f0f4f8; /* Slightly darker background for rows */
            padding: 12px 18px;
            border-radius: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .pronunciation-row p {
            flex-grow: 1;
            color: #2d3748;
            font-weight: 500;
            font-size: 1.05rem;
        }
        .pronunciation-row button {
            padding: 10px 20px;
            background-color: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            font-size: 0.95rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .pronunciation-row button:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
        }
        .pronunciation-row button i {
            margin-right: 5px;
        }

        /* Loading overlay styling */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95); /* Whiter, slightly more opaque */
            display: flex;
            flex-direction: column; /* Stack spinner and text */
            justify-content: center;
            align-items: center;
            z-index: 1001;
            display: none;
            transition: opacity 0.3s ease;
            opacity: 0;
        }
        .loading-overlay.show {
            opacity: 1;
            display: flex;
        }
        .spinner {
            border: 8px solid #e0e7ff;
            border-top: 8px solid #6366f1; /* Indigo spinner */
            border-radius: 50%;
            width: 70px; /* Larger spinner */
            height: 70px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px; /* Space between spinner and text */
        }
        .loading-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #4a5568;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Quiz options styling */
        .quiz-option {
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 12px;
            cursor: pointer;
            background-color: #ffffff;
            transition: all 0.2s ease;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .quiz-option:hover {
            background-color: #f0f4f8;
            border-color: #a7b9e0;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .quiz-option.correct {
            background-color: #d1fae5; /* Light green */
            border-color: #34d399; /* Green border */
            font-weight: 600;
            box-shadow: 0 0 0 2px #34d399; /* Green ring */
            animation: pulseCorrect 0.5s ease-out;
        }
        .quiz-option.incorrect {
            background-color: #fee2e2; /* Light red */
            border-color: #ef4444; /* Red border */
            font-weight: 600;
            box-shadow: 0 0 0 2px #ef4444; /* Red ring */
            animation: shakeIncorrect 0.5s ease-out;
        }
        .quiz-feedback {
            margin-top: 20px;
            font-weight: 600; 
            font-size: 1.1rem; 
            text-align: center;
            padding: 10px;
            border-radius: 8px;
        }
        .quiz-feedback.correct { 
            color: #059669; 
            background-color: #d1fae5;
        }
        .quiz-feedback.incorrect { 
            color: #dc2626; 
            background-color: #fee2e2;
        }
        .quiz-feedback-explanation {
            font-size: 0.95rem;
            color: #4a5568;
            margin-top: 8px;
            font-style: italic;
        }

        @keyframes shakeIncorrect {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        @keyframes pulseCorrect {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }


        /* Generate button container */
        .generate-btn-container {
            text-align: right;
            margin-top: 20px;
        }
        .generate-btn {
            padding: 11px 22px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            background-image: linear-gradient(to right, #60a5fa, #3b82f6); /* Blue gradient */
            color: white;
            border: none;
            transition: all 0.25s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        .generate-btn:hover {
            background-image: linear-gradient(to right, #3b82f6, #2563eb);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.15);
        }
        .generate-btn i {
            margin-left: 8px;
        }

        /* Translation sub-section */
        .translation-sub-section h4 {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
            margin-top: 25px;
            border-bottom: 1px solid #cbd5e1;
            padding-bottom: 8px;
        }
        .translation-sub-section p { padding-left: 15px; }

        /* Style select group */
        .style-select-group {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            background-color: #f0f4f8;
            padding: 12px 18px;
            border-radius: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .style-select-group label {
            font-weight: 700;
            color: #2d3748;
            font-size: 1.05rem;
        }
        .style-select-group select {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            background-color: #ffffff;
            cursor: pointer;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.06);
            transition: all 0.2s ease;
        }
        .style-select-group select:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        /* List item specific styling for generated features */
        .word-family-list li strong, .suffix-prefix-list li strong, .idioms-phrases-list li strong, .cultural-context-list li strong, .collocations-list li strong {
            color: #2d3748;
            margin-right: 8px;
        }
        .word-family-list li::before, .suffix-prefix-list li::before, .idioms-phrases-list li::before, .cultural-context-list li::before, .collocations-list li::before {
            content: '•'; /* Dot bullet for these lists */
            color: #6366f1; /* Indigo dot */
        }

        /* Long text content scrolling */
        .scrollable-content {
            max-height: 200px; /* Adjust as needed */
            overflow-y: auto;
            padding-right: 10px; /* Space for scrollbar */
        }

        /* Visually hidden for accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 25px;
                gap: 20px;
            }
            .input-group {
                flex-direction: column; /* Stack input and buttons vertically */
                align-items: stretch; /* Make them full width */
            }
            .btn, .input-group input {
                width: 100%; /* Ensure full width on small screens */
                min-width: unset; /* Remove min-width constraint */
            }
            .data-card, .meaning-section {
                padding: 20px;
                margin-top: 15px;
            }
            .data-card h3 {
                font-size: 1.3rem;
                margin-bottom: 12px;
            }
            .meaning-section h4 {
                font-size: 1.15rem;
            }
            .saved-words-list {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* Smaller min-width for very small screens */
            }
            .modal-content {
                padding: 30px;
            }
            .modal-content h3 {
                font-size: 1.75rem;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            .data-card h3 {
                font-size: 1.15rem;
            }
            .meaning-section h4 {
                font-size: 1rem;
            }
            .input-group input, .btn {
                font-size: 0.95rem;
                padding: 12px 15px;
            }
            .pronunciation-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .pronunciation-row button {
                width: 100%;
                text-align: center;
            }
            .style-select-group {
                flex-direction: column;
                align-items: stretch;
            }
            .style-select-group select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-5 flex items-center justify-center gap-3">
            <i class="fas fa-book-open text-indigo-600"></i> Vocabulary Checker
        </h1>

        <div class="input-group">
            <label for="wordInput" class="sr-only">Enter a word</label>
            <input type="text" id="wordInput" placeholder="Enter a word (e.g., beautiful)" class="focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="searchBtn" class="btn btn-primary" aria-label="Search Word"><i class="fas fa-search"></i> Search Word</button>
            <button id="saveBtn" class="btn btn-secondary" aria-label="Save Current Word"><i class="fas fa-save"></i> Save Current Word</button>
            <button id="loadBtn" class="btn btn-secondary" aria-label="Load Saved Words"><i class="fas fa-folder-open"></i> Load Saved Words</button>
        </div>

        <!-- Word of the Day Section -->
        <div id="wordOfTheDaySection" class="data-card show" aria-live="polite">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center"><i class="fas fa-calendar-day text-indigo-600"></i> Word of the Day</h2>
            <p class="text-xl font-semibold text-center text-gray-900 mb-2" id="wotdWord"></p>
            <p class="text-gray-700 text-center mb-4" id="wotdDefinition"></p>
            <div class="text-center">
                <button id="wotdSearchBtn" class="btn btn-primary" aria-label="Search Word of the Day"><i class="fas fa-search"></i> Learn More</button>
            </div>
        </div>

        <div id="resultDisplay" class="hidden" aria-live="polite">
            <h2 id="displayWord" class="text-4xl font-extrabold text-gray-900 mb-4 capitalize text-center py-2 px-4 rounded-lg bg-indigo-50 shadow-md"></h2>

            <div id="pronunciationCard" class="data-card feature-card">
                <h3><i class="fas fa-volume-up"></i> Pronunciation</h3>
                <div class="pronunciation-row">
                    <p>US: <span id="usPronunciation"></span></p>
                    <button id="playUsPronunciation" aria-label="Play US Pronunciation"><i class="fas fa-play"></i> Play US</button>
                </div>
                <div class="pronunciation-row mt-2">
                    <p>UK: <span id="ukPronunciation"></span></p>
                    <button id="playUkPronunciation" aria-label="Play UK Pronunciation"><i class="fas fa-play"></i> Play UK</button>
                </div>
            </div>

            <div id="meaningsContainer" class="mt-4"></div>
            
            <div id="generateMeaningContainer" class="hidden text-center mt-2 mb-4">
                <button id="generateMeaningBtn" class="btn btn-secondary" aria-label="Next Meaning"><i class="fas fa-arrow-right"></i> Next Meaning</button>
            </div>

            <!-- ALL ORIGINAL FEATURE CARDS RESTORED - now with feature-card class -->
            <div id="storyCard" class="data-card feature-card">
                <h3><i class="fas fa-book"></i> Word in Context Story</h3>
                <p id="storyText" class="scrollable-content"></p>
                <div class="generate-btn-container">
                    <button id="generateStoryBtn" class="generate-btn" aria-label="Generate Story">Generate Story <i class="fas fa-magic"></i></button>
                </div>
            </div>
            <div id="usageTipsCard" class="data-card feature-card">
                <h3><i class="fas fa-lightbulb"></i> Usage Tips & Common Mistakes</h3>
                <p id="usageTipsText" class="scrollable-content"></p>
                <div class="generate-btn-container">
                    <button id="generateTipsBtn" class="generate-btn" aria-label="Generate Usage Tips">Generate Tips <i class="fas fa-magic"></i></button>
                </div>
            </div>
            <div id="quizCard" class="data-card feature-card">
                <h3><i class="fas fa-question-circle"></i> Quiz Question</h3>
                <p id="quizQuestionText" class="mb-3"></p>
                <div id="quizOptionsContainer" class="flex flex-col gap-3"></div>
                <div id="quizFeedback" class="quiz-feedback hidden" aria-live="assertive"></div>
                <div class="generate-btn-container">
                    <button id="generateQuizBtn" class="generate-btn" aria-label="Generate Quiz">Generate Quiz <i class="fas fa-magic"></i></button>
                </div>
            </div>
            <div id="etymologyCard" class="data-card feature-card">
                <h3><i class="fas fa-font"></i> Etymology / Word Origin</h3>
                <p id="etymologyText" class="scrollable-content"></p>
                <div class="generate-btn-container">
                    <button id="generateEtymologyBtn" class="generate-btn" aria-label="Generate Etymology">Generate Etymology <i class="fas fa-magic"></i></button>
                </div>
            </div>
            <div id="relatedConceptsCard" class="data-card feature-card">
                <h3><i class="fas fa-link"></i> Related Concepts / Topics</h3>
                <p id="relatedConceptsText" class="scrollable-content"></p>
                <div class="generate-btn-container">
                    <button id="generateConceptsBtn" class="generate-btn" aria-label="Generate Related Concepts">Generate Concepts <i class="fas fa-magic"></i></button>
                </div>
            </div>
            <div id="nuancesCard" class="data-card feature-card">
                <h3><i class="fas fa-adjust"></i> Synonym/Antonym Nuances</h3>
                <p id="nuanceText" class="scrollable-content"></p>
                <div class="generate-btn-container">
                    <button id="generateNuancesBtn" class="generate-btn" aria-label="Generate Nuances">Generate Nuances <i class="fas fa-magic"></i></button>
                </div>
            </div>
            <div id="translationCard" class="data-card feature-card">
                <h3><i class="fas fa-language"></i> Cross-Language Translation</h3>
                <div class="mb-4">
                    <label for="translationLanguage" class="block text-gray-700 text-sm font-bold mb-2">Select Language:</label>
                    <select id="translationLanguage" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="bangla">Bengali (Bangla)</option>
                        <option value="korean">Korean</option>
                        <option value="japanese">Japanese</option>
                        <option value="filipino">Filipino</option>
                        <option value="indonesian">Indonesian</option>
                        <option value="chinese">Chinese (Simplified)</option>
                        <option value="french">French</option>
                        <option value="italian">Italian</option>
                        <option value="arabic">Arabic</option>
                        <option value="german">German</option>
                        <option value="russian">Russian</option>
                    </select>
                </div>
                <div id="translationDisplay" class="scrollable-content"></div>
                <div class="generate-btn-container">
                    <button id="generateTranslationBtn" class="generate-btn" aria-label="Generate Translation">Generate Translation <i class="fas fa-magic"></i></button>
                </div>
            </div>
            <div id="styledUsageCard" class="data-card feature-card">
                <h3><i class="fas fa-pencil-alt"></i> Word Usage in Different Styles</h3>
                <div class="style-select-group">
                    <label for="usageStyle">Select Style:</label>
                    <select id="usageStyle">
                        <option value="formal">Formal</option>
                        <option value="informal">Informal</option>
                        <option value="poetic">Poetic</option>
                        <option value="journalistic">Journalistic</option>
                    </select>
                </div>
                <p id="styledExampleText" class="scrollable-content"></p>
                <div class="generate-btn-container">
                    <button id="generateStyledExampleBtn" class="generate-btn" aria-label="Generate Styled Example">Generate Example <i class="fas fa-magic"></i></button>
                </div>
            </div>
             <div id="wordFamilyCard" class="data-card feature-card">
                <h3><i class="fas fa-sitemap"></i> Word Family / Related Terms</h3>
                <ul id="wordFamilyList" class="word-family-list scrollable-content"></ul>
                <div class="generate-btn-container">
                    <button id="generateWordFamilyBtn" class="generate-btn" aria-label="Generate Word Family">Generate Word Family <i class="fas fa-magic"></i></button>
                </div>
            </div>
            <div id="suffixPrefixCard" class="data-card feature-card">
                <h3><i class="fas fa-grip-lines"></i> Suffix / Prefix</h3>
                <ul id="suffixPrefixList" class="suffix-prefix-list scrollable-content"></ul>
                <div class="generate-btn-container">
                    <button id="generateSuffixPrefixBtn" class="generate-btn" aria-label="Generate Suffix/Prefix">Generate Suffix / Prefix <i class="fas fa-magic"></i></button>
                </div>
            </div>
            <div id="idiomsPhrasesCard" class="data-card feature-card">
                <h3><i class="fas fa-comments"></i> Idioms & Phrases</h3>
                <ul id="idiomsPhrasesList" class="idioms-phrases-list scrollable-content"></ul>
                <div class="generate-btn-container">
                    <button id="generateIdiomsBtn" class="generate-btn" aria-label="Generate Idioms">Generate Idioms <i class="fas fa-magic"></i></button>
                </div>
            </div>
            <div id="culturalContextCard" class="data-card feature-card">
                <h3><i class="fas fa-globe"></i> Cultural Context / Usage Nuances</h3>
                <p id="culturalContextText" class="scrollable-content"></p>
                <div class="generate-btn-container">
                    <button id="generateCulturalContextBtn" class="generate-btn" aria-label="Generate Cultural Context">Generate Context <i class="fas fa-magic"></i></button>
                </div>
            </div>
            <div id="collocationsCard" class="data-card feature-card">
                <h3><i class="fas fa-puzzle-piece"></i> Common Collocations</h3>
                <ul id="collocationsList" class="collocations-list scrollable-content"></ul>
                <div class="generate-btn-container">
                    <button id="generateCollocationsBtn" class="generate-btn" aria-label="Generate Collocations">Generate Collocations <i class="fas fa-magic"></i></button>
                </div>
            </div>
        </div>

        <div id="savedWordsSection" class="data-card hidden" aria-live="polite">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center"><i class="fas fa-bookmark text-indigo-600"></i> Your Saved Words</h2>
            <ul id="savedWordsList" class="saved-words-list"></ul>
            <div class="mt-5 text-center">
                 <button id="clearSavedBtn" class="btn btn-secondary" aria-label="Clear All Saved Words"><i class="fas fa-trash-alt"></i> Clear All Saved Words</button>
            </div>
        </div>

        <div id="messageModal" class="message-modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalMessage">
            <div class="modal-content" id="modalContent">
                <h3 id="modalTitle"></h3>
                <p id="modalMessage"></p>
                <button id="modalCloseBtn"></button>
            </div>
        </div>

        <div id="loadingOverlay" class="loading-overlay" role="status" aria-live="assertive" aria-atomic="true">
            <div class="spinner"></div>
            <p class="loading-text">Generating content...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const dom = {
                wordInput: document.getElementById('wordInput'),
                searchBtn: document.getElementById('searchBtn'),
                saveBtn: document.getElementById('saveBtn'),
                loadBtn: document.getElementById('loadBtn'),
                clearSavedBtn: document.getElementById('clearSavedBtn'),
                resultDisplay: document.getElementById('resultDisplay'),
                displayWord: document.getElementById('displayWord'),
                pronunciationCard: document.getElementById('pronunciationCard'),
                usPronunciation: document.getElementById('usPronunciation'),
                ukPronunciation: document.getElementById('ukPronunciation'),
                playUsPronunciation: document.getElementById('playUsPronunciation'),
                playUkPronunciation: document.getElementById('playUkPronunciation'),
                meaningsContainer: document.getElementById('meaningsContainer'),
                generateMeaningContainer: document.getElementById('generateMeaningContainer'),
                generateMeaningBtn: document.getElementById('generateMeaningBtn'),
                storyCard: document.getElementById('storyCard'),
                storyText: document.getElementById('storyText'),
                generateStoryBtn: document.getElementById('generateStoryBtn'),
                usageTipsCard: document.getElementById('usageTipsCard'),
                usageTipsText: document.getElementById('usageTipsText'),
                generateTipsBtn: document.getElementById('generateTipsBtn'),
                quizCard: document.getElementById('quizCard'),
                quizQuestionText: document.getElementById('quizQuestionText'),
                quizOptionsContainer: document.getElementById('quizOptionsContainer'),
                quizFeedback: document.getElementById('quizFeedback'),
                generateQuizBtn: document.getElementById('generateQuizBtn'),
                etymologyCard: document.getElementById('etymologyCard'),
                etymologyText: document.getElementById('etymologyText'),
                generateEtymologyBtn: document.getElementById('generateEtymologyBtn'),
                relatedConceptsCard: document.getElementById('relatedConceptsCard'),
                relatedConceptsText: document.getElementById('relatedConceptsText'),
                generateConceptsBtn: document.getElementById('generateConceptsBtn'),
                nuancesCard: document.getElementById('nuancesCard'),
                nuanceText: document.getElementById('nuanceText'),
                generateNuancesBtn: document.getElementById('generateNuancesBtn'),
                translationCard: document.getElementById('translationCard'),
                translationLanguage: document.getElementById('translationLanguage'),
                translationDisplay: document.getElementById('translationDisplay'),
                generateTranslationBtn: document.getElementById('generateTranslationBtn'),
                styledUsageCard: document.getElementById('styledUsageCard'),
                usageStyle: document.getElementById('usageStyle'),
                styledExampleText: document.getElementById('styledExampleText'),
                generateStyledExampleBtn: document.getElementById('generateStyledExampleBtn'),
                wordFamilyCard: document.getElementById('wordFamilyCard'),
                wordFamilyList: document.getElementById('wordFamilyList'),
                generateWordFamilyBtn: document.getElementById('generateWordFamilyBtn'),
                suffixPrefixCard: document.getElementById('suffixPrefixCard'),
                suffixPrefixList: document.getElementById('suffixPrefixList'),
                generateSuffixPrefixBtn: document.getElementById('generateSuffixPrefixBtn'),
                idiomsPhrasesCard: document.getElementById('idiomsPhrasesCard'),
                idiomsPhrasesList: document.getElementById('idiomsPhrasesList'),
                generateIdiomsBtn: document.getElementById('generateIdiomsBtn'),
                culturalContextCard: document.getElementById('culturalContextCard'),
                culturalContextText: document.getElementById('culturalContextText'),
                generateCulturalContextBtn: document.getElementById('generateCulturalContextBtn'),
                collocationsCard: document.getElementById('collocationsCard'),
                collocationsList: document.getElementById('collocationsList'),
                generateCollocationsBtn: document.getElementById('generateCollocationsBtn'),
                savedWordsSection: document.getElementById('savedWordsSection'),
                savedWordsList: document.getElementById('savedWordsList'),
                messageModal: document.getElementById('messageModal'),
                modalTitle: document.getElementById('modalTitle'),
                modalMessage: document.getElementById('modalMessage'),
                modalCloseBtn: document.getElementById('modalCloseBtn'),
                modalContent: document.getElementById('modalContent'),
                loadingOverlay: document.getElementById('loadingOverlay'),
                wotdWord: document.getElementById('wotdWord'),
                wotdDefinition: document.getElementById('wotdDefinition'),
                wotdSearchBtn: document.getElementById('wotdSearchBtn'),
                wordOfTheDaySection: document.getElementById('wordOfTheDaySection'),
            };

            const featureCards = [
                dom.pronunciationCard, dom.storyCard, dom.usageTipsCard, dom.quizCard,
                dom.etymologyCard, dom.relatedConceptsCard, dom.nuancesCard,
                dom.translationCard, dom.styledUsageCard, dom.wordFamilyCard,
                dom.suffixPrefixCard, dom.idiomsPhrasesCard, dom.culturalContextCard,
                dom.collocationsCard
            ];

            const allGenerateButtons = [
                dom.generateStoryBtn, dom.generateTipsBtn, dom.generateQuizBtn,
                dom.generateEtymologyBtn, dom.generateConceptsBtn, dom.generateNuancesBtn,
                dom.generateTranslationBtn, dom.generateStyledExampleBtn,
                dom.generateWordFamilyBtn, dom.generateSuffixPrefixBtn,
                dom.generateIdiomsBtn, dom.generateCulturalContextBtn, dom.generateCollocationsBtn
            ];

            let state = {
                currentWord: '',
                currentWordData: null,
                displayedMeaningIndex: -1,
                featureContentCurrentlyDisplayedMeaningIndex: { 
                    story: -1, usageTips: -1, quiz: -1, etymology: -1, relatedConcepts: -1,
                    nuances: -1, translation: -1, styledExample: -1, wordFamily: -1,
                    suffixPrefix: -1, idiomsPhrases: -1, culturalContext: -1, collocations: -1
                }
            };

            const showGlobalLoading = (message = "Generating content...") => {
                dom.loadingOverlay.querySelector('.loading-text').textContent = message;
                dom.loadingOverlay.classList.add('show');
            };
            const hideGlobalLoading = () => dom.loadingOverlay.classList.remove('show');

            function hideMessage() {
                dom.messageModal.classList.remove('show');
                const existingNoBtn = dom.modalContent.querySelector('#modalNoBtn');
                if (existingNoBtn) existingNoBtn.remove();
            }

            function showMessage(title, message, onConfirmCallback = null) {
                hideGlobalLoading();
                dom.modalTitle.textContent = title;
                dom.modalMessage.textContent = message;
                const existingNoBtn = dom.modalContent.querySelector('#modalNoBtn');
                if (existingNoBtn) existingNoBtn.remove();
                dom.modalCloseBtn.textContent = 'OK';
                dom.modalCloseBtn.className = 'btn btn-primary';
                dom.modalCloseBtn.onclick = hideMessage;

                if (onConfirmCallback) {
                    dom.modalCloseBtn.textContent = 'Yes';
                    const noBtn = document.createElement('button');
                    noBtn.id = 'modalNoBtn';
                    noBtn.textContent = 'No';
                    noBtn.className = 'btn btn-secondary ml-4';
                    noBtn.onclick = hideMessage;
                    dom.modalContent.appendChild(noBtn);
                    dom.modalCloseBtn.onclick = () => {
                        onConfirmCallback();
                        hideMessage();
                    };
                }
                dom.messageModal.classList.add('show');
            }
            
            function speakText(text, lang) {
                if ('speechSynthesis' in window) {
                    if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = lang;
                    window.speechSynthesis.speak(utterance);
                } else {
                    showMessage('Speech Not Supported', 'Your browser does not support the Web Speech API.');
                }
            }

            async function callGeminiAPI(prompt, schema) {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: schema ? "application/json" : "text/plain",
                    }
                };
                if (schema) payload.generationConfig.responseSchema = schema;

                const apiKey = "AIzaSyB1_pV6pkD1ohLBe18ey0gy6Pz4BRXD8Dg"; // The API key is automatically provided by the Canvas runtime.
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API call failed: ${response.status}. ${errorBody.substring(0, 200)}...`);
                    }

                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("API returned an unexpected response format.");
                    }
                } catch (fetchError) {
                    throw new Error(`Failed to communicate with the API. ${fetchError.message}`);
                }
            }

            function displayQuiz(quiz, element, feedbackElement, optionsContainer) {
                optionsContainer.innerHTML = '';
                feedbackElement.innerHTML = ''; // Clear previous feedback
                feedbackElement.classList.add('hidden');
                if (!quiz || !quiz.question || !quiz.options || quiz.options.length === 0) {
                    element.textContent = 'No quiz question generated.';
                    return;
                }
                element.textContent = quiz.question;
                quiz.options.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'quiz-option';
                    optionDiv.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                    optionDiv.dataset.answer = option;
                    optionDiv.setAttribute('tabindex', '0');
                    optionDiv.addEventListener('click', (e) => checkQuizAnswer(e.target, quiz, feedbackElement, optionsContainer));
                    optionDiv.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') checkQuizAnswer(e.target, quiz, feedbackElement, optionsContainer);
                    });
                    optionsContainer.appendChild(optionDiv);
                });
            }

            function checkQuizAnswer(selectedOptionElement, quiz, feedbackElement, optionsContainer) {
                const { correctAnswer, explanation } = quiz;
                const allOptions = optionsContainer.querySelectorAll('.quiz-option');
                allOptions.forEach(option => {
                    option.style.pointerEvents = 'none'; // Disable further clicks
                    option.removeAttribute('tabindex'); // Remove from tab order after selection
                    if (option.dataset.answer === correctAnswer) {
                        option.classList.add('correct');
                    }
                });

                const isCorrect = selectedOptionElement.dataset.answer === correctAnswer;
                
                if (isCorrect) {
                    selectedOptionElement.classList.add('correct');
                    feedbackElement.innerHTML = `
                        <p>Correct! Well done.</p>
                        <p class="quiz-feedback-explanation">${explanation}</p>
                    `;
                    feedbackElement.className = 'quiz-feedback correct';
                } else {
                    selectedOptionElement.classList.add('incorrect');
                    feedbackElement.innerHTML = `
                        <p>Incorrect. The correct answer was: "${correctAnswer}"</p>
                        <p class="quiz-feedback-explanation">${explanation}</p>
                    `;
                    feedbackElement.className = 'quiz-feedback incorrect';
                }
                feedbackElement.classList.remove('hidden');
            }
            
            function renderFeatureContent(featureKey, data, element) {
                // Clear previous content based on featureKey
                const clearContent = () => {
                    switch (featureKey) {
                        case 'quiz': dom.quizQuestionText.textContent = ''; dom.quizOptionsContainer.innerHTML = ''; dom.quizFeedback.classList.add('hidden'); dom.quizFeedback.innerHTML = ''; break;
                        case 'translation': dom.translationDisplay.innerHTML = ''; break;
                        case 'wordFamily': case 'suffixPrefix': case 'idiomsPhrases': case 'collocations': element.innerHTML = ''; break;
                        default: if (element) element.textContent = '';
                    }
                };
                clearContent();

                // Render new content
                if (!data) return;
                switch (featureKey) {
                    case 'quiz': displayQuiz(data, dom.quizQuestionText, dom.quizFeedback, dom.quizOptionsContainer); break;
                    case 'translation': element.innerHTML = data; break;
                    case 'wordFamily': case 'suffixPrefix': case 'idiomsPhrases': case 'collocations':
                        if (data.length > 0) {
                            data.forEach(item => {
                                const li = document.createElement('li');
                                if (featureKey === 'wordFamily') li.innerHTML = `<strong>${item.type}:</strong> ${item.word}`;
                                if (featureKey === 'suffixPrefix') li.innerHTML = `<strong>${item.type}: ${item.affix}</strong> - ${item.meaning}`;
                                if (featureKey === 'idiomsPhrases') li.innerHTML = `<strong>${item.phrase}:</strong> ${item.meaning} (e.g., "${item.example}")`;
                                if (featureKey === 'collocations') li.innerHTML = `<strong>${item.collocation}</strong> (e.g., "${item.example}")`;
                                element.appendChild(li);
                            });
                        } else {
                            const li = document.createElement('li');
                            li.textContent = `No ${featureKey.replace(/([A-Z])/g, ' $1').toLowerCase()} found.`;
                            li.classList.add('no-content');
                            element.appendChild(li);
                        }
                        break;
                    default: if (element) element.textContent = data;
                }
            }

            function updateFeatureButtonText(featureKey) {
                const btn = document.getElementById(`generate${featureKey.charAt(0).toUpperCase() + featureKey.slice(1)}Btn`);
                if (!btn || !state.currentWordData || state.currentWordData.meanings.length === 0) return;

                const currentMeaning = state.currentWordData.meanings[state.displayedMeaningIndex];
                const hasContentForCurrentMeaning = currentMeaning.generatedFeatures?.[featureKey];
                const featureDisplayName = featureKey.replace(/([A-Z])/g, ' $1').trim();

                if (!hasContentForCurrentMeaning) {
                    btn.innerHTML = `Generate ${featureDisplayName} <i class="fas fa-magic"></i>`;
                } else {
                    btn.innerHTML = `Regenerate ${featureDisplayName} <i class="fas fa-sync-alt"></i>`;
                }
            }

            function displayCurrentMeaning() {
                if (!state.currentWordData || state.displayedMeaningIndex === -1) return;

                const meaning = state.currentWordData.meanings[state.displayedMeaningIndex];
                dom.meaningsContainer.innerHTML = '';
                const meaningSection = document.createElement('div');
                meaningSection.className = 'meaning-section';
                let partOfSpeechText = meaning.partOfSpeech ? meaning.partOfSpeech.charAt(0).toUpperCase() + meaning.partOfSpeech.slice(1) : 'N/A';
                
                meaningSection.innerHTML = `
                    <h4>Meaning ${state.displayedMeaningIndex + 1} (${partOfSpeechText}):</h4>
                    <p>${meaning.definition || 'Definition not available.'}</p>
                    <h5 class="font-semibold text-gray-700 mt-3">Synonyms:</h5>
                    <ul>${(meaning.synonyms?.length > 0 && meaning.synonyms[0] !== 'none available') ? meaning.synonyms.map(s => `<li>${s}</li>`).join('') : '<li class="no-content">No synonyms found.</li>'}</ul>
                    <h5 class="font-semibold text-gray-700 mt-3">Antonyms:</h5>
                    <ul>${(meaning.antonyms?.length > 0 && meaning.antonyms[0] !== 'none available') ? meaning.antonyms.map(a => `<li>${a}</li>`).join('') : '<li class="no-content">No antonyms found.</li>'}</ul>
                    <h5 class="font-semibold text-gray-700 mt-3">Example Sentences:</h5>
                    <ul>${(meaning.examples?.length > 0) ? meaning.examples.map(e => `<li>${e}</li>`).join('') : '<li class="no-content">No example sentences found.</li>'}</ul>
                `;
                dom.meaningsContainer.appendChild(meaningSection);
                setTimeout(() => meaningSection.classList.add('show'), 50);

                if (state.currentWordData.meanings.length > 1) {
                    dom.generateMeaningContainer.classList.remove('hidden');
                    dom.generateMeaningBtn.innerHTML = `Next Meaning (${(state.displayedMeaningIndex + 1) % state.currentWordData.meanings.length + 1}/${state.currentWordData.meanings.length}) <i class="fas fa-arrow-right"></i>`;
                } else {
                    dom.generateMeaningContainer.classList.add('hidden');
                }

                Object.keys(state.featureContentCurrentlyDisplayedMeaningIndex).forEach(featureKey => {
                    const data = meaning.generatedFeatures?.[featureKey];
                    const element = dom[`${featureKey}Text`] || dom[`${featureKey}List`] || dom[`${featureKey}Display`];
                    renderFeatureContent(featureKey, data, element);
                    state.featureContentCurrentlyDisplayedMeaningIndex[featureKey] = state.displayedMeaningIndex;
                    updateFeatureButtonText(featureKey);
                });
            }

            function displayWordData(word, data) {
                dom.resultDisplay.classList.remove('hidden');
                dom.savedWordsSection.classList.add('hidden');
                dom.wordOfTheDaySection.classList.add('hidden');
                
                state.currentWordData = data;
                state.currentWord = word;
                state.displayedMeaningIndex = 0;

                dom.displayWord.textContent = word;
                dom.usPronunciation.textContent = data.pronunciation?.us || 'N/A';
                dom.ukPronunciation.textContent = data.pronunciation?.uk || 'N/A';

                state.currentWordData.meanings.forEach(meaning => {
                    if (!meaning.generatedFeatures) meaning.generatedFeatures = {};
                });

                Object.keys(state.featureContentCurrentlyDisplayedMeaningIndex).forEach(key => {
                    state.featureContentCurrentlyDisplayedMeaningIndex[key] = -1;
                });

                if (data.meanings?.length > 0) {
                    displayCurrentMeaning();
                } else {
                    dom.meaningsContainer.innerHTML = '<p class="text-center text-gray-600 mt-8">No meanings were found.</p>';
                    dom.generateMeaningContainer.classList.add('hidden');
                }

                featureCards.forEach((card, index) => {
                    card.classList.remove('show', 'hidden');
                    setTimeout(() => card.classList.add('show'), 100 * index);
                });
                dom.displayWord.focus();
            }

            async function handleFeatureButtonClick(featureKey, promptFunc, element, schema = null) {
                if (!state.currentWordData || state.currentWordData.meanings.length === 0) {
                    showMessage('No Word', 'Please search for a word first.');
                    return;
                }
                showGlobalLoading(`Generating ${featureKey.replace(/([A-Z])/g, ' $1').toLowerCase()}...`);
                try {
                    const currentMeaningIndex = state.displayedMeaningIndex;
                    const meaning = state.currentWordData.meanings[currentMeaningIndex];
                    const prompt = promptFunc(state.currentWord, meaning);
                    const result = await callGeminiAPI(prompt, schema);
                    const data = schema ? JSON.parse(result) : result;
                    
                    if (!meaning.generatedFeatures) meaning.generatedFeatures = {};
                    meaning.generatedFeatures[featureKey] = data;
                    
                    renderFeatureContent(featureKey, data, element);
                    state.featureContentCurrentlyDisplayedMeaningIndex[featureKey] = currentMeaningIndex;
                    updateFeatureButtonText(featureKey);
                } catch (error) {
                    showMessage('Error', `Could not generate ${featureKey}. ${error.message}`);
                } finally {
                    hideGlobalLoading();
                }
            }

            async function fetchWordOfTheDay() {
                showGlobalLoading("Fetching Word of the Day...");
                try {
                    const prompt = `Provide a single, underrated, challenging, or less common English word and its concise definition (1-2 sentences). Respond in JSON format: {"word": "...", "definition": "..."}`;
                    const schema = { type: "OBJECT", properties: { word: { type: "STRING" }, definition: { type: "STRING" } }, required: ["word", "definition"] };
                    const jsonString = await callGeminiAPI(prompt, schema);
                    const wotdData = JSON.parse(jsonString);
                    dom.wotdWord.textContent = wotdData.word;
                    dom.wotdDefinition.textContent = wotdData.definition;
                } catch (error) {
                    dom.wotdWord.textContent = "Error";
                    dom.wotdDefinition.textContent = "Could not fetch Word of the Day.";
                } finally {
                    hideGlobalLoading();
                }
            }
            
            dom.searchBtn.addEventListener('click', async () => {
                const word = dom.wordInput.value.trim().toLowerCase();
                if (!word) {
                    showMessage('Input Required', 'Please enter a word.');
                    return;
                }
                showGlobalLoading('Searching word...');
                try {
                    const prompt = `For the word '${word}', provide an array of all its distinct meanings. For each meaning, include its partOfSpeech, definition, a list of synonyms (or an empty array if none), a list of antonyms (or an empty array if none), and 3 example sentences. Also, provide US and UK phonetic spellings. Respond in JSON.`;
                    const schema = { type: "OBJECT", properties: { word: { type: "STRING" }, pronunciation: { type: "OBJECT", properties: { us: { type: "STRING" }, uk: { type: "STRING" } } }, meanings: { type: "ARRAY", items: { type: "OBJECT", properties: { partOfSpeech: { type: "STRING" }, definition: { type: "STRING" }, synonyms: { type: "ARRAY", items: { type: "STRING" } }, antonyms: { type: "ARRAY", items: { type: "STRING" } }, examples: { type: "ARRAY", items: { type: "STRING" } } } } } }, required: ["word", "pronunciation", "meanings"] };
                    const jsonString = await callGeminiAPI(prompt, schema);
                    const parsedData = JSON.parse(jsonString);

                    if (!parsedData || !parsedData.word || !parsedData.meanings) {
                        throw new Error("API response is missing essential data.");
                    }

                    displayWordData(word, parsedData);
                    dom.wordInput.value = '';
                    
                } catch (error) {
                    showMessage('Error', `Could not fetch data for "${word}". ${error.message}`);
                    dom.resultDisplay.classList.add('hidden');
                } finally {
                    hideGlobalLoading();
                }
            });
            
            dom.generateMeaningBtn.addEventListener('click', () => {
                if (!state.currentWordData || state.currentWordData.meanings.length === 0) return;
                state.displayedMeaningIndex = (state.displayedMeaningIndex + 1) % state.currentWordData.meanings.length;
                displayCurrentMeaning();
            });

            // --- Individual Generate Button Listeners (for regeneration) ---
            dom.generateStoryBtn.addEventListener('click', () => handleFeatureButtonClick('story', (word, m) => `Write a short, engaging paragraph (3-5 sentences) using the word '${word}' in the context of its meaning: "${m.definition}".`, dom.storyText));
            dom.generateTipsBtn.addEventListener('click', () => handleFeatureButtonClick('usageTips', (word, m) => `Provide a concise paragraph (2-4 sentences) explaining common usage tips or mistakes for the word '${word}' based on its meaning: "${m.definition}".`, dom.usageTipsText));
            
            // ENHANCED QUIZ BUTTON
            dom.generateQuizBtn.addEventListener('click', () => {
                const promptFunc = (word, meaning) => `Generate a challenging multiple-choice quiz question for the word '${word}' based *only* on this specific meaning: "${meaning.definition}". The question should test the user's understanding of this exact definition. Provide 4 options. The incorrect options should be plausible but subtly wrong (e.g., related but incorrect meanings, or synonyms that don't fit the context). Also provide the correct answer and a brief, one-sentence explanation for why it's correct. Respond in JSON format.`;
                const schema = {
                    type: "OBJECT",
                    properties: {
                        question: { type: "STRING" },
                        options: { type: "ARRAY", items: { "type": "STRING" } },
                        correctAnswer: { type: "STRING" },
                        explanation: { type: "STRING" }
                    },
                    required: ["question", "options", "correctAnswer", "explanation"]
                };
                handleFeatureButtonClick('quiz', promptFunc, dom.quizQuestionText, schema);
            });

            dom.generateEtymologyBtn.addEventListener('click', () => handleFeatureButtonClick('etymology', (word) => `Provide a concise etymology for the word '${word}'.`, dom.etymologyText));
            dom.generateConceptsBtn.addEventListener('click', () => handleFeatureButtonClick('relatedConcepts', (word, m) => `List some concepts or topics related to '${word}' based on its meaning: "${m.definition}".`, dom.relatedConceptsText));
            dom.generateNuancesBtn.addEventListener('click', () => handleFeatureButtonClick('nuances', (word, m) => `Explain the nuances between '${word}' and its common synonyms based on its meaning: "${m.definition}".`, dom.nuanceText));
            dom.generateTranslationBtn.addEventListener('click', () => handleFeatureButtonClick('translation', (word, m) => `Translate the word '${word}' into ${dom.translationLanguage.options[dom.translationLanguage.selectedIndex].text} based on its meaning: "${m.definition}". Provide the translation and any brief, relevant usage notes.`, dom.translationDisplay));
            dom.generateStyledExampleBtn.addEventListener('click', () => handleFeatureButtonClick('styledExample', (word, m) => `Write a single example sentence using the word '${word}' in a ${dom.usageStyle.value} style, based on its meaning: "${m.definition}".`, dom.styledExampleText));
            dom.generateWordFamilyBtn.addEventListener('click', () => handleFeatureButtonClick('wordFamily', (word) => `Provide a list of word family members for '${word}' (noun, verb, etc.). Respond in JSON: [{"type": "noun", "word": "example"}]`, dom.wordFamilyList, { type: "ARRAY", items: { type: "OBJECT", properties: { type: { type: "STRING" }, word: { type: "STRING" } }, required: ["type", "word"] } }));
            dom.generateSuffixPrefixBtn.addEventListener('click', () => handleFeatureButtonClick('suffixPrefix', (word) => `List common prefixes and suffixes for '${word}'. Respond in JSON: [{"type": "prefix", "affix": "-un", "meaning": "not"}]`, dom.suffixPrefixList, { type: "ARRAY", items: { type: "OBJECT", properties: { type: { type: "STRING" }, affix: { type: "STRING" }, meaning: { type: "STRING" } }, required: ["type", "affix", "meaning"] } }));
            dom.generateIdiomsBtn.addEventListener('click', () => handleFeatureButtonClick('idiomsPhrases', (word, m) => `List idioms using '${word}' relevant to its meaning: "${m.definition}". Respond in JSON: [{"phrase": "...", "meaning": "...", "example": "..."}]`, dom.idiomsPhrasesList, { type: "ARRAY", items: { type: "OBJECT", properties: { phrase: { type: "STRING" }, meaning: { type: "STRING" }, example: { type: "STRING" } }, required: ["phrase", "meaning", "example"] } }));
            dom.generateCollocationsBtn.addEventListener('click', () => handleFeatureButtonClick('collocations', (word, m) => `List common collocations for '${word}' relevant to its meaning: "${m.definition}". Respond in JSON: [{"collocation": "...", "example": "..."}]`, dom.collocationsList, { type: "ARRAY", items: { type: "OBJECT", properties: { collocation: { type: "STRING" }, example: { type: "STRING" } }, required: ["collocation", "example"] } }));
            dom.generateCulturalContextBtn.addEventListener('click', () => handleFeatureButtonClick('culturalContext', (word, m) => `Explain any cultural context or regional usage differences for '${word}' related to its meaning: "${m.definition}".`, dom.culturalContextText));

            // --- System Event Listeners ---
            dom.wordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') dom.searchBtn.click(); });
            dom.playUsPronunciation.addEventListener('click', () => state.currentWord && speakText(state.currentWord, 'en-US'));
            dom.playUkPronunciation.addEventListener('click', () => state.currentWord && speakText(state.currentWord, 'en-GB'));
            
            dom.saveBtn.addEventListener('click', () => {
                if (!state.currentWord || !state.currentWordData) { showMessage('Error', 'No word to save.'); return; }
                let savedWords = JSON.parse(localStorage.getItem('savedVocabulary')) || {};
                savedWords[state.currentWord] = state.currentWordData;
                localStorage.setItem('savedVocabulary', JSON.stringify(savedWords));
                
                dom.saveBtn.classList.add('bg-green-500', 'text-white');
                dom.saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                setTimeout(() => {
                    dom.saveBtn.classList.remove('bg-green-500', 'text-white');
                    dom.saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Current Word';
                }, 1500);
            });

            dom.loadBtn.addEventListener('click', () => {
                let savedWords = {};
                try {
                    savedWords = JSON.parse(localStorage.getItem('savedVocabulary')) || {};
                } catch (e) {
                    showMessage('Error', 'Could not load saved words due to data corruption.');
                    return;
                }
                
                const wordsArray = Object.keys(savedWords);
                dom.resultDisplay.classList.add('hidden');
                dom.wordOfTheDaySection.classList.add('hidden');
                dom.savedWordsSection.classList.remove('hidden');
                dom.savedWordsSection.classList.add('show');
                dom.savedWordsList.innerHTML = '';

                if (wordsArray.length > 0) {
                    wordsArray.forEach(word => {
                        const li = document.createElement('li');
                        li.textContent = word;
                        li.dataset.word = word;
                        li.setAttribute('tabindex', '0');
                        li.addEventListener('click', (e) => {
                            const clickedWord = e.target.dataset.word;
                            dom.savedWordsSection.classList.add('hidden');
                            displayWordData(clickedWord, savedWords[clickedWord]);
                        });
                        li.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') e.target.click();
                        });
                        dom.savedWordsList.appendChild(li);
                    });
                } else {
                    showMessage('No Saved Words', 'Your vocabulary is empty.');
                }
            });

            dom.clearSavedBtn.addEventListener('click', () => {
                showMessage('Confirm Clear', 'Are you sure you want to delete all saved words?', () => {
                    localStorage.removeItem('savedVocabulary');
                    dom.savedWordsList.innerHTML = '';
                    dom.savedWordsSection.classList.add('hidden');
                    showMessage('Cleared', 'All saved words have been deleted.');
                });
            });

            dom.wotdSearchBtn.addEventListener('click', () => {
                const word = dom.wotdWord.textContent;
                if (word && word !== "Error") {
                    dom.wordInput.value = word;
                    dom.searchBtn.click();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.shiftKey && e.key === 'Enter') {
                    for (const btn of allGenerateButtons) {
                        if (btn && btn.offsetParent !== null && !btn.disabled) {
                            btn.click();
                            e.preventDefault();
                            break;
                        }
                    }
                }
            });

            // --- Initial Setup ---
            featureCards.forEach(card => card.classList.add('hidden'));
            fetchWordOfTheDay();
            dom.wordInput.focus();
        });
    </script>
</body>
</html>
